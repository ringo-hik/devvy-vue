/**
 * Devvy Bot API ì‹¤ì œ ì—°ë™ ì„œë¹„ìŠ¤
 * - ì‹¤ì œ ë°±ì—”ë“œ APIì™€ í†µì‹ í•˜ì—¬ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤.
 * - API Endpoint: /api/v1/devportal/devvy
 */

import axios from 'axios';

// Axios ì¸ìŠ¤í„´ìŠ¤ ìƒì„±. baseURLì„ ì„¤ì •í•˜ì—¬ ì½”ë“œ ì¤‘ë³µì„ ì¤„ì…ë‹ˆë‹¤.
const apiClient = axios.create({
  baseURL: '/api/v1/devportal/devvy', // ë°±ì—”ë“œ API ê¸°ë³¸ ê²½ë¡œ
  headers: {
    'Content-Type': 'application/json',
  }
});

/**
 * API ìš”ì²­ í›„ ê³µí†µ ì²˜ë¦¬ ë¡œì§
 * @param {Promise} request - axios ìš”ì²­ Promise
 * @returns {Promise<Object>} - { success: boolean, data: any, error: string|null }
 */
const handleRequest = async (request) => {
  try {
    const response = await request;
    // ë°±ì—”ë“œì—ì„œ success: trueì™€ í•¨ê»˜ ë³´ë‚¸ ë°ì´í„°ê°€ response.data.dataì— ìˆì„ ê²½ìš°
    if (response.data && response.data.success) {
      return { success: true, data: response.data.data, message: response.data.message };
    }
    // ì„±ê³µí–ˆì§€ë§Œ ë°ì´í„° êµ¬ì¡°ê°€ ë‹¤ë¥¸ ê²½ìš° (e.g. health check)
    if (response.status === 200) {
        return { success: true, data: response.data };
    }
    // ë°±ì—”ë“œì—ì„œ success: falseë¡œ ì‘ë‹µí•œ ê²½ìš°
    return { success: false, error: response.data.errorMessage || 'An unknown error occurred.' };
  } catch (error) {
    console.error('ğŸ’¥ API Request ailed:', error);
    const errorMessage = error.response?.data?.errorMessage || error.message || 'Network error or server is not responding.';
    return { success: false, error: errorMessage };
  }
};

const devvyService = {
  /**
   * ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
   */
  healthCheck() {
    return handleRequest(apiClient.get('/health'));
  },

  /**
   * ì±—ë´‡ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   */
  getCategories() {
    return handleRequest(apiClient.get('/categories'));
  },

  /**
   * AIì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ë‹µë³€ì„ ë°›ìŠµë‹ˆë‹¤.
   * @param {Object} requestData - { categoryId, message, sessionId }
   */
  sendMessage(requestData) {
    return handleRequest(apiClient.post('/chat', requestData));
  },

  /**
   * ì‚¬ìš©ìì˜ ì „ì²´ ëŒ€í™” íˆìŠ¤í† ë¦¬ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   */
  getChatHistory() {
    return handleRequest(apiClient.get('/history'));
  },

  /**
   * íŠ¹ì • ì„¸ì…˜ì˜ ìƒì„¸ ë©”ì‹œì§€ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   * @param {string} sessionId - ì¡°íšŒí•  ì„¸ì…˜ ID
   */
  getSessionMessages(sessionId) {
    return handleRequest(apiClient.get(`/sessions/${sessionId}/messages`));
  },

  /**
   * ì‚¬ìš©ì í”¼ë“œë°±ì„ ì„œë²„ì— ì „ì†¡í•©ë‹ˆë‹¤.
   * @param {Object} feedbackData - { rating, content, category, sessionId }
   */
  sendFeedback(feedbackData) {
    return handleRequest(apiClient.post('/feedback', feedbackData));
  },
};

// ë™ì  ë¡œë”© ë©”ì‹œì§€ëŠ” API ì„œë¹„ìŠ¤ê°€ ì•„ë‹Œ UI ë¡œì§ì— ì†í•˜ë¯€ë¡œ,
// ê¸°ì¡´ê³¼ ê°™ì´ ChatTab.vueì—ì„œ ì§ì ‘ ê´€ë¦¬í•˜ê±°ë‚˜ ë³„ë„ì˜ UI ìœ í‹¸ë¦¬í‹° íŒŒì¼ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
const LOADING_MESSAGES = {
    ko: [
      "âœ… Devvyê°€ ìµœì ì˜ ë‹µë³€ì„ ì°¾ê³  ìˆì–´ìš”.", "ğŸ§  AIì˜ ë‰´ëŸ°ì´ í™œë°œí•˜ê²Œ ì›€ì§ì´ëŠ” ì¤‘...", "ë°ì´í„°ì˜ ë°”ë‹¤ì—ì„œ ì •ë³´ë¥¼ íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤ ğŸŒŠ", "ì ì‹œë§Œìš”, ê±°ì˜ ë‹¤ ëì–´ìš”! ğŸš€", "ë§ˆë²• ê°™ì€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤ âœ¨"
    ],
    en: [
      "âœ… Devvy is finding the optimal answer.", "ğŸ§  AI neurons are firing up...", "Navigating the sea of data ğŸŒŠ", "Just a moment, almost there! ğŸš€", "Generating a magical response âœ¨"
    ]
};

// ì´ í•¨ìˆ˜ëŠ” UI ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ export í•©ë‹ˆë‹¤.
export function getLoadingMessage(language = 'ko') {
    const messages = LOADING_MESSAGES[language] || LOADING_MESSAGES.en;
    return messages[Math.floor(Math.random() * messages.length)];
}


export default devvyService;
